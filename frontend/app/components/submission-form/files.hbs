<input type="file" multiple accept={{join ', ' @state.fileSet.allowedExtensions}} class="d-none" {{did-insert (set this 'fileInputElement')}} {{on 'change' (pipe (pick 'target.files' this.addFiles) (set this 'fileInputElement.value' ''))}} {{!-- template-lint-disable require-input-label --}} />

<form {{on 'submit' (prevent-default this.goNext)}}>
  <div class="vstack gap-3">
    <div class="card">
      <div class="card-body">
        <p>
          <a href="https://www.ddbj.nig.ac.jp/ddbj/ume.html" target="_blank" rel="noopener noreferrer">UME</a> (Parser, transChecker) でチェック済みの登録ファイルを作成済みであればアップロードしてください。
        </p>

        <RadioGroup as |group|>
          <div class="form-check">
            <group.radio as |radio|>
              <radio.input checked={{eq @state.submissionFileType 'dfast'}} required class="form-check-input" {{on 'change' (fn this.setSubmissionFileType 'dfast')}} />

              <radio.label class="form-check-label">
                DFAST で作成した Bacterial complete genome または WGS の登録ファイルをアップロードする
              </radio.label>
            </group.radio>
          </div>

          <div class="form-check">
            <group.radio as |radio|>
              <radio.input checked={{eq @state.submissionFileType 'without-dfast'}} required class="form-check-input" {{on 'change' (fn this.setSubmissionFileType 'without-dfast')}} />

              <radio.label class="form-check-label">
                DFAST を使わず作成した登録ファイルをアップロードする
              </radio.label>
            </group.radio>
          </div>

          <div class="form-check">
            <group.radio as |radio|>
              <radio.input checked={{eq @state.submissionFileType 'none'}} required class="form-check-input" {{on 'change' (fn this.setSubmissionFileType 'none')}} />

              <radio.label class="form-check-label">
                申し込み後に登録ファイルを作成する
              </radio.label>
            </group.radio>
          </div>
        </RadioGroup>
      </div>
    </div>

    {{#if (or (eq @state.submissionFileType 'dfast') (eq @state.submissionFileType 'without-dfast'))}}
      <div class="card">
        <div class="card-body">
          <ul>
            <li>登録ファイルを圧縮せずにアップロードしてください。</li>
            <li>前提条件に従っていれば、複数セットの登録ファイルをアップロードできます。</li>
            <li>各 Submission のファイル拡張子は必ず <code>.ann</code> (アノテーションファイル)、<code>.fasta</code> (塩基配列) とし、拡張子を除く名称を同一にしてください。</li>
            <li>Linux の <code>ls</code> コマンドでの名前ソート順に Accession 番号が発行されます。</li>
          </ul>

          {{#if @state.fileSet.files}}
            <div class="card {{if this.dragOver 'drag-over opacity-50 border-primary'}}" {{drop-target this.addFiles enter=(set this 'dragOver' true) leave=(set this 'dragOver' false)}}>
              <ul class="list-group list-group-flush overflow-auto" style="max-height: 550px">
                {{#each (sort-by 'name' @state.fileSet.files) as |file|}}
                  <li class="list-group-item hstack gap-2 align-items-center">
                    <div class="align-self-start">
                      {{#if file.isParsing}}
                        <div class="spinner-border spinner-border-seconcary spinner-border-sm opacity-50" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      {{else}}
                        {{#if (or file.errors (and file.isAnnotation @state.fileSet.annotationFileErrors))}}
                          {{svg-jar 'x-circle-fill-16' class='octicon fill-danger' style='margin-top: 2.5px;'}}
                        {{else}}
                          {{svg-jar 'check-circle-fill-16' class='octicon fill-success' style='margin-top: 2.5px;'}}
                        {{/if}}
                      {{/if}}
                    </div>

                    <div class={{if file.isParsing 'opacity-50'}}>
                      {{file.name}}

                      <small class="text-muted">{{filesize file.size}}</small>

                      <small class={{if file.errors 'text-danger' 'text-muted'}}>
                        {{#if file.isParsing}}
                          Parsing...
                        {{else}}
                          <div class="hstack gap-3 text-muted">
                            {{#with file.parsedData as |data|}}
                              {{#if file.isAnnotation}}
                                <div>
                                  <b>Contact person</b>
                                  {{#with data.contactPerson as |person|}}
                                    {{person.fullName}}
                                    &lt;{{person.email}}&gt;
                                    ({{person.affiliation}})
                                  {{else}}
                                    -
                                  {{/with}}
                                </div>

                                <div>
                                  <b>Hold date</b>
                                  {{or data.holdDate '-'}}
                                </div>
                              {{/if}}

                              {{#if file.isSequence}}
                                <div>
                                  <b>エントリ数</b>
                                  {{format-number data.entriesCount}}
                                </div>
                              {{/if}}
                            {{/with}}
                          </div>

                          {{#if file.errors}}
                            <ul class="list-unstyled text-danger">
                              {{#each file.errors as |error|}}
                                <li>{{error}}</li>
                              {{/each}}
                            </ul>
                          {{/if}}
                        {{/if}}
                      </small>
                    </div>

                    <div class="ms-auto">
                      <button type="button" class="btn btn-link p-2" {{on 'click' (prevent-default (fn this.removeFile file))}}>
                        {{svg-jar 'no-entry-24' class='octicon fill-danger' role='img' desc='削除'}}
                      </button>
                    </div>
                  </li>
                {{/each}}
              </ul>

              {{#with @state.fileSet.annotationFileErrors as |errors|}}
                <div class="card-body">
                  <ul class="text-danger mb-0">
                    {{#each errors as |error|}}
                      <li>{{error}}</li>
                    {{/each}}
                  </ul>
                </div>
              {{/with}}

              <div class="card-footer d-flex justify-content-between align-items-center bg-white">
                <div>
                  <button type="button" class="btn btn-outline-primary" {{on 'click' (prevent-default this.selectFiles)}}>
                    ファイルの追加
                  </button>
                </div>

                <div>
                  {{@state.fileSet.files.length}}ファイル、{{filesize (sum (map-by 'size' @state.fileSet.files))}}
                </div>
              </div>
            </div>
          {{else}}
            <div class="card border-2 border-dashed {{if this.dragOver 'drag-over opacity-50 border-primary'}}" {{drop-target this.addFiles enter=(set this 'dragOver' true) leave=(set this 'dragOver' false)}}>
              <div class="card-body py-5 text-center text-muted">
                <a href="#" class="stretched-link" {{on 'click' (prevent-default this.selectFiles)}}>ファイルを選択</a>するか、ここにファイルをドロップしてください。
              </div>
            </div>
          {{/if}}
        </div>
      </div>
    {{/if}}
  </div>

  <hr />

  <div class="hstack gap-3 justify-content-end">
    <a href class="btn btn-outline-primary px-4" {{on 'click' (prevent-default @nav.goPrev)}}>戻る</a>
    <button type="submit" class="btn btn-primary px-5" disabled={{this.isNextButtonDisabled}}>次へ</button>
  </div>
</form>
